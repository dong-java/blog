<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.sxyfyr.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Nginx 核心知识 100 讲学习笔记初识 nginx nginx 适用场景 静态资源服务：通过本地文件系统提供服务。 反向代理服务：nginx 的强大性能，缓存，负载均衡。 API 服务：OpenResty">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 核心知识 100 讲">
<meta property="og:url" content="https://www.sxyfyr.com/2021/03/04/Nginx%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86100%E8%AE%B2/index.html">
<meta property="og:site_name" content="董的个人笔记">
<meta property="og:description" content="Nginx 核心知识 100 讲学习笔记初识 nginx nginx 适用场景 静态资源服务：通过本地文件系统提供服务。 反向代理服务：nginx 的强大性能，缓存，负载均衡。 API 服务：OpenResty">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091505.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091749.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091840.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216092424.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161345.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161346.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216101743.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161349.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216131303.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216181821.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182404.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161348.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182712.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182731.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183110.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183149.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183404.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216194217.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216194438.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200058.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161350.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200647.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200814.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200841.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160445.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160514.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160531.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162314.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162425.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162529.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219163038.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219171227.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219172505.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219172555.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219173023.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174239.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174302.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174400.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210220095723.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210220105242.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210220111129.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202101/20210220111153.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220111521.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220111636.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220113227.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220113241.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220114939.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220134608.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220135654.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220135932.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220144002.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220145725.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220145826.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220151044.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220151852.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220152722.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220152733.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155144.png">
<meta property="og:image" content="c:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210220155228796.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155334.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155501.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220160244.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163040.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163110.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163148.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163541.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163658.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163739.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163753.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165321.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165105.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165958.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171006.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171019.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171027.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171036.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171050.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171105.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171330.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171402.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220172816.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220174902.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220174923.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220180039.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210220180108.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222151516.png">
<meta property="og:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210222160837.png">
<meta property="article:published_time" content="2021-03-04T12:04:07.000Z">
<meta property="article:modified_time" content="2021-03-04T06:09:17.259Z">
<meta property="article:author" content="dong">
<meta property="article:tag" content="Nginx">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091505.png">

<link rel="canonical" href="https://www.sxyfyr.com/2021/03/04/Nginx%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86100%E8%AE%B2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Nginx 核心知识 100 讲 | 董的个人笔记</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?a1426d1b389c9b23d384d67485e84ecb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">董的个人笔记</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://www.sxyfyr.com/2021/03/04/Nginx%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86100%E8%AE%B2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="dong">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="董的个人笔记">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx 核心知识 100 讲
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2021-03-04 20:04:07 / 修改时间：14:09:17" itemprop="dateCreated datePublished" datetime="2021-03-04T20:04:07+08:00">2021-03-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%9E%81%E5%AE%A2%E6%97%B6%E9%97%B4/" itemprop="url" rel="index"><span itemprop="name">极客时间</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>40k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>37 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Nginx核心知识100讲学习笔记"><a href="#Nginx核心知识100讲学习笔记" class="headerlink" title="Nginx核心知识100讲学习笔记"></a>Nginx 核心知识 100 讲学习笔记</h1><h1 id="初识nginx"><a href="#初识nginx" class="headerlink" title="初识nginx"></a>初识 nginx</h1><ol>
<li><p>nginx 适用场景</p>
<p>静态资源服务：通过本地文件系统提供服务。</p>
<p>反向代理服务：nginx 的强大性能，缓存，负载均衡。</p>
<p>API 服务：OpenResty</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091505.png" alt="image-20210216091502611"></p>
<span id="more"></span></li>
<li><p>Nginx 的优点</p>
<ul>
<li><p>高并发，高性能</p>
</li>
<li><p>可扩展性好</p>
</li>
<li><p>高可靠性</p>
</li>
<li><p>热部署</p>
</li>
<li><p>BSD 许可证（开源免费）</p>
</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091749.png" alt="image-20210216091747299"></p>
</li>
<li><p>Nginx 的组成</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216091840.png" alt="image-20210216091839131"></p>
</li>
<li><p>Nginx 的版本发布</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216092424.png" alt="image-20210216092422869"></p>
</li>
<li><p>nginx 编译</p>
<ul>
<li>vim 语法支持  <code>cp -r contrib/vim/* ~/.vim/</code></li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161345.png" alt="image-20210216094538152"></p>
<ul>
<li><p>查看帮助文件</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs nginx-1.18.0]# ./configure --help|more</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">第一类</span><br><span class="line"> </span><br><span class="line">--prefix=PATH</span><br><span class="line"> </span><br><span class="line">第二类：使用哪些和不使用哪些模块</span><br><span class="line"> </span><br><span class="line">--with-http_ssl_module          #默认是不编译进nginx的</span><br><span class="line">--without-http_charset_module   #默认是编译进nginx，加这个参数就是卸载这个模块</span><br><span class="line"> </span><br><span class="line">第三类：特殊优化参数</span><br><span class="line">  --with-cc=PATH                     set C compiler pathname</span><br><span class="line">  --with-cpp=PATH                    set C preprocessor pathname</span><br><span class="line">  --with-cc-opt=OPTIONS              set additional C compiler options</span><br><span class="line">  --with-ld-opt=OPTIONS              set additional linker options</span><br><span class="line">  --with-cpu-opt=CPU</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>中间文件介绍</p>
<p><strong>生成中间文件在什么地方？</strong></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>-<span class="number">1.18</span><span class="type">.0</span>]<span class="comment"># cd objs/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">5148</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">17457</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> autoconf.err</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">40144</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> Makefile</span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">5130480</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> nginx</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">5375</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> nginx.<span class="number">8</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">7037</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_auto_config.h</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root     <span class="number">657</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_auto_headers.h</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">5856</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_modules.c   <span class="comment">#所有的模块都放在 ngx_modules.c</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">45232</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> ngx_modules.o</span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span> <span class="number">9</span> root root      <span class="number">91</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> src</span><br></pre></td></tr></tbody></table></figure>

<p><strong>为什么要知道 nginx 编译中间文件是放在这里呢？</strong></p>
<p>在进行 nginx 版本升级的时候不能执行 make instal 需要把中间文件拷贝到安装目录下</p>
<p><strong>c 语言编辑生成的所有中间目录都会放在 src 目录中</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/[root@ecs objs]# cd src</span><br><span class="line">[root@ecs src]# ll</span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 2 root root 4096 Feb 16 09:55 core</span><br><span class="line">drwxr-xr-x 3 root root  191 Feb 16 09:55 event</span><br><span class="line">drwxr-xr-x 4 root root 4096 Feb 16 09:55 http</span><br><span class="line">drwxr-xr-x 2 root root    6 Feb 16 09:53 mail</span><br><span class="line">drwxr-xr-x 2 root root    6 Feb 16 09:53 misc</span><br><span class="line">drwxr-xr-x 4 root root   31 Feb 16 09:53 os</span><br><span class="line">drwxr-xr-x 2 root root    6 Feb 16 09:53 stream</span><br></pre></td></tr></tbody></table></figure>

<p>如果使用了动态模块、生成的 so 文件也会放在这个目录下</p>
</li>
<li><p>编译安装</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">编译安装nginx需要pcre包，未安装会有如下提示：</span><br><span class="line">./configure: error: the HTTP rewrite module requires the PCRE library.</span><br><span class="line">You can either disable the module by using --without-http_rewrite_module</span><br><span class="line">option, or install the PCRE library into the system, or build the PCRE library</span><br><span class="line">statically from the source with nginx by using --with-pcre=&lt;path&gt; option.</span><br><span class="line"></span><br><span class="line">需要安装pcre的devel包，pcre-devel。使用yum安装即可：（以下命令还带有ssl、zlib等依赖的安装）</span><br><span class="line">yum -y install zlib zlib-devel openssl openssl-devel pcre pcre-devel</span><br><span class="line"></span><br><span class="line">再重新编译安装</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>nginx 配置语法</p>
<p>配置文件由指令与指令块构成 </p>
<p>每条指令以；分号结尾，指令与参数间以空格符号分隔 </p>
<p>指令块以｛｝大括号将多条指令组织在一起 </p>
<p>include 语句允许组合多个配置文件以提升可维护性 </p>
<p>使用 #符号添加注释，提高可读性</p>
<p>使用 $ 符号使用变量</p>
<p>部分指令的参数支持正则表达式</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161346.png" alt="image-20210216101716303"></p>
</li>
<li><p>nginx 的命令行</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216101743.png" alt="image-20210216101741507"></p>
<ul>
<li><p>重载配置文件</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs sbin]# ./nginx </span><br><span class="line">[root@ecs sbin]# ps -ef|grep nginx</span><br><span class="line">root      254641       1  0 10:21 ?        00:00:00 nginx: master process ./nginx</span><br><span class="line">nobody    254642  254641  0 10:21 ?        00:00:00 nginx: worker process</span><br><span class="line">root      254644  221527  0 10:21 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@ecs sbin]# vim ../conf/nginx.conf</span><br><span class="line">[root@ecs sbin]# ./nginx -s reload</span><br><span class="line">[root@ecs sbin]# ps -ef|grep nginx</span><br><span class="line">root      254641       1  0 10:21 ?        00:00:00 nginx: master process ./nginx</span><br><span class="line">nobody    254682  254641  0 10:22 ?        00:00:00 nginx: worker process</span><br><span class="line">root      254694  221527  0 10:23 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>热部署</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">sbin</span>]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/nginx/sbin</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">sbin</span>]<span class="comment"># cp nginx nginx.old</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">sbin</span>]<span class="comment"># cd /data/soft/nginx/nginx-1.18.0/objs/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">5148</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">17457</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> autoconf.err</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">40144</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> Makefile</span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">5130480</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> nginx</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">5375</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> nginx.<span class="number">8</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">7037</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_auto_config.h</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root     <span class="number">657</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_auto_headers.h</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">5856</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> ngx_modules.c</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root   <span class="number">45232</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> ngx_modules.o</span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span> <span class="number">9</span> root root      <span class="number">91</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">53</span> src</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># cp -r nginx /usr/local/nginx/sbin/ -f</span></span><br><span class="line"><span class="built_in">cp</span>: overwrite <span class="string">'/usr/local/nginx/sbin/nginx'</span>? y</span><br><span class="line"><span class="comment">#给master进程发送一个信号，用新的nginx启动</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># kill -USR2 254641</span></span><br><span class="line"><span class="comment"># 可以看到新旧进程都在运行</span></span><br><span class="line"><span class="comment"># 新的master会生成新的work，老的master和work也在运行，他们会平滑的把所有的请求过度到新的二进制文件启的进程中</span></span><br><span class="line"><span class="comment"># 老的master和work已经不再监听80和443端口 所以新的请求，新的连接会进入新的nginx</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># ps -ef|grep nginx</span></span><br><span class="line">root      <span class="number">254641</span>       <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master <span class="keyword">process</span> ./nginx</span><br><span class="line">nobody    <span class="number">254682</span>  <span class="number">254641</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">22</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker <span class="keyword">process</span></span><br><span class="line">root      <span class="number">254778</span>  <span class="number">254641</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">35</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master <span class="keyword">process</span> ./nginx</span><br><span class="line">nobody    <span class="number">254779</span>  <span class="number">254778</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">35</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker <span class="keyword">process</span></span><br><span class="line">root      <span class="number">254789</span>  <span class="number">221527</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">36</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto nginx</span><br><span class="line"><span class="comment"># 优雅的关闭所有work进程</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># kill -WINCH 254641</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># ps -ef|grep nginx</span></span><br><span class="line">root      <span class="number">254641</span>       <span class="number">1</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">21</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master <span class="keyword">process</span> ./nginx</span><br><span class="line">root      <span class="number">254778</span>  <span class="number">254641</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">35</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: master <span class="keyword">process</span> ./nginx</span><br><span class="line">nobody    <span class="number">254779</span>  <span class="number">254778</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">35</span> ?        <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> nginx: worker <span class="keyword">process</span></span><br><span class="line">root      <span class="number">254800</span>  <span class="number">221527</span>  <span class="number">0</span> <span class="number">10</span>:<span class="number">40</span> pts/<span class="number">0</span>    <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> grep -<span class="literal">-color</span>=auto nginx</span><br><span class="line"><span class="comment"># 老的master进程还在运行、所有的请求已经转接到新的nginx上了 但是我们又可能会发生一些问题</span></span><br><span class="line"><span class="comment"># 新版本退回到老版本，所以我们还可以给老的master发送信号重新把老的work拉起来</span></span><br><span class="line"><span class="comment"># 老的master是不会自动退出 允许我们做版本回退</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>切割日志</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs logs]# mv access.log bak.log</span><br><span class="line">[root@ecs logs]# ll</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 nobody root   0 Feb 16 10:21 bak.log</span><br><span class="line">-rw-r--r-- 1 nobody root 438 Feb 16 10:49 error.log</span><br><span class="line">-rw-r--r-- 1 root   root   7 Feb 16 10:35 nginx.pid</span><br><span class="line">-rw-r--r-- 1 root   root   7 Feb 16 10:21 nginx.pid.oldbin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新启动之后会重新生成access.log</span></span><br><span class="line">[root@ecs logs]# ../sbin/nginx -s reopen</span><br><span class="line">[root@ecs logs]# ll</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 nobody root   0 Feb 16 10:50 access.log</span><br><span class="line">-rw-r--r-- 1 nobody root   0 Feb 16 10:21 bak.log</span><br><span class="line">-rw-r--r-- 1 nobody root 500 Feb 16 10:50 error.log</span><br><span class="line">-rw-r--r-- 1 root   root   7 Feb 16 10:35 nginx.pid</span><br><span class="line">-rw-r--r-- 1 root   root   7 Feb 16 10:21 nginx.pid.oldbin</span><br><span class="line"><span class="meta">#</span><span class="bash"> 定时切割日志</span></span><br><span class="line">[root@ecs logs]# crontab -l</span><br><span class="line">0 0 1 * * root /usr/local/nginx/logs/rotate.sh</span><br><span class="line">[root@ecs logs]# cat rotate.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">LOGS_PATH=/usr/local/nginx/logs/history</span><br><span class="line">CUR_LOGS_PATH=/usr/local/nginx/logs</span><br><span class="line">YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)</span><br><span class="line">mv ${CUR_LOGS_PATH}/access.log ${LOGS_PATH}/access_${YESTERDAY}.log</span><br><span class="line">mv ${CUR_LOGS_PATH}/error.log ${LOGS_PATH}/error_${YESTERDAY}.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> 向nginx主进程发送USR1信号。USR1信号是重新打开日志文件</span></span><br><span class="line">kill -USR1 $(cat /usr/local/nginx/logs/nginx.pid)</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>搭建静态资源</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># vi conf/nginx.conf</span></span><br><span class="line">server {</span><br><span class="line">		listen <span class="number">8080</span>;</span><br><span class="line">		server_name www.test.com;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#charset koi8-r;</span></span><br><span class="line">		</span><br><span class="line">		access_log logs/test.access.log main;</span><br><span class="line">		</span><br><span class="line">		location / {</span><br><span class="line">			alis dlib/;</span><br><span class="line">			<span class="comment"># 打开目录</span></span><br><span class="line">			<span class="comment">#autoindex on;</span></span><br><span class="line">			<span class="comment"># 限制访问速度</span></span><br><span class="line">			<span class="comment">#set $limit_rate 1k;</span></span><br><span class="line">			<span class="comment">#index index.html index.htm;</span></span><br><span class="line">		}</span><br><span class="line">		</span><br><span class="line">		<span class="comment">#error_page 404 /404.html;</span></span><br><span class="line">	}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161349.png" alt="image-20210216131359256"></p>
<p>打开 gzip</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gzip  on;</span><br><span class="line">gzip_min_length 1;</span><br><span class="line">gzip_comp_level 2;</span><br><span class="line">gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png;</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216131303.png" alt="image-20210216131257211"></p>
</li>
<li><p>搭建具备缓存功能的反向代理服务</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">nginx.conf</span></span><br><span class="line">proxy_cache_path /tmp/nginxcache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=60m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">upstream local {</span><br><span class="line">   server 127.0.0.1:8080;</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">	   proxy_set_header Host $host;</span><br><span class="line">           proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">           proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">	   proxy_cache my_cache;</span><br><span class="line"></span><br><span class="line">	   proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">	   proxy_cache_valid 200 304 302 1d;</span><br><span class="line">   	   proxy_pass http://local;</span><br><span class="line">        }</span><br><span class="line">	</span><br><span class="line"><span class="meta">	#</span><span class="bash">error_page 404 /404.html;</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">        listen 127.0.0.1:8080;</span><br><span class="line">        #server_name www.test.com;</span><br><span class="line"></span><br><span class="line">        #charset koi8-r;</span><br><span class="line"></span><br><span class="line">        access_log logs/test.access.log main;</span><br><span class="line"></span><br><span class="line">        location / {</span><br><span class="line">                alias dlib/;</span><br><span class="line">                autoindex on;</span><br><span class="line">                set $limit_rate 1k;</span><br><span class="line">                index index.html index.htm;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        #error_page 404 /404.html;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">upstream local {</span><br><span class="line">   server 127.0.0.1:8080;</span><br><span class="line">}</span><br><span class="line">server {</span><br><span class="line">	listen 80;</span><br><span class="line">	server_name www.test.com;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">	   proxy_set_header Host $host;</span><br><span class="line">       proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line"></span><br><span class="line">	   proxy_cache my_cache;</span><br><span class="line"></span><br><span class="line">	   proxy_cache_key $host$uri$is_args$args;</span><br><span class="line">	   proxy_cache_valid 200 304 302 1d;</span><br><span class="line">   	   proxy_pass http://local;</span><br><span class="line">     }</span><br><span class="line">	</span><br><span class="line"><span class="meta">	 #</span><span class="bash">error_page 404 /404.html;</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>用 GoAccess 实现可视化并实时监控 access 日志</p>
<ul>
<li><p>安装 GoAccess <code>https://www.goaccess.cc/?mod=download</code></p>
<p>说明：</p>
<p>GoAccess 在使用源码安装时，依赖下列组件。 </p>
<p>为方便最终日志统计时显示 IP 地理位置，需要安装依赖项 GeoIP-devel：</p>
<p>执行命令：<em>yum install GeoIP-devel.x86_64</em> </p>
<p>安装 ncurses-devel 开发库：</p>
<p>执行命令：<em>yum install ncurses-devel</em>  </p>
<p>安装 openssl-devel 开发库：</p>
<p>执行命令：<em>yum install openssl-devel</em></p>
</li>
<li><p>执行报错</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">logs</span>]<span class="comment"># goaccess test.access.log -o ../html/report.html --real-time-html --time-format='%H:%M:%S'--date-format='%d/%b/%Y' --log-format=COMBINE</span></span><br><span class="line"></span><br><span class="line">GoAccess - version <span class="number">1.2</span> - Feb <span class="number">16</span> <span class="number">2021</span> <span class="number">17</span>:<span class="number">14</span>:<span class="number">24</span></span><br><span class="line">Config file: /usr/local/etc/goaccess.conf</span><br><span class="line"></span><br><span class="line">Fatal error has occurred</span><br><span class="line">Error occured at: src/parser.c - parse_log - <span class="number">2705</span></span><br><span class="line">No date format was found on your conf file.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成报告</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">logs</span>]<span class="comment"># goaccess test.access.log -a -o ../html/report.html</span></span><br><span class="line"><span class="comment"># 配置nginx,访问查看</span></span><br><span class="line">location /report.html {</span><br><span class="line">	alias /usr/local/nginx/html/report.html;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216181821.png" alt="image-20210216181819318"></p>
</li>
</ul>
</li>
<li><p>从网络协议来看 SSL 安全协议</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182404.png" alt="image-20210216182402487"></p>
<ul>
<li>TLS 安全密码套件解读</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161348.png" alt="image-20210216182532032"></p>
</li>
<li><p>对称加密与非对称加密各自的应用场景</p>
<ul>
<li>对称加密</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182712.png" alt="image-20210216182710344"></p>
<ul>
<li>非对称加密</li>
</ul>
</li>
</ol>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216182731.png" alt="image-20210216182729612"></p>
<ol start="13">
<li><p> SSL 证书的公信力是如何保证的？</p>
<ul>
<li>PKI 公钥基础设施</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183110.png" alt="image-20210216183108379"></p>
<ul>
<li>证书类型</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183149.png" alt="image-20210216183147565"></p>
</li>
<li><p> SSL 协议握手时 Nginx 的性能瓶颈在哪里？</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216183404.png" alt="image-20210216183402502"></p>
</li>
<li><p>用免费 SSL 证书实现一个 HTTPS 站点</p>
<p>安装</p>
<p><code>yum install certbot python2-certbot-nginx -y</code></p>
<p>配置</p>
<p><code>certbot --nginx --nginx-server-root=/usr/local/nginx/conf/ -d www.test.com</code></p>
<p>nginx 配置</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">listen 443 ssl; # managed by Certbot</span><br><span class="line">ssl_certificate /etc/letsencrypt/live/pazzn.com/fullchain.pem; # managed by Certbot</span><br><span class="line">ssl_certificate_key /etc/letsencrypt/live/pazzn.com/privkey.pem; # managed by Certbot</span><br><span class="line">include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot</span><br><span class="line">ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>基于 OpenResty 用 Lua 语言实现简单服务</p>
<ul>
<li>下载安装 openresty</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs soft]# wget https://openresty.org/download/openresty-1.19.3.1.tar.gz</span><br><span class="line">[root@ecs openresty-1.19.3.1]# ./configure</span><br></pre></td></tr></tbody></table></figure>

<p>添加 Lua 代码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /lua {</span><br><span class="line">    default_type text/html;</span><br><span class="line">    content_by_lua 'ngx.say("User-Agent: ", ngx.req.get_headers()["User-Agent"])';</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<h1 id="Nginx架构基础-一"><a href="#Nginx架构基础-一" class="headerlink" title="Nginx架构基础(一)"></a>Nginx 架构基础 (一)</h1><ol>
<li><p>Nginx 请求处理流程</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216194217.png" alt="image-20210216194216098"></p>
</li>
<li><p>Nginx 进程结构</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216194438.png" alt="image-20210216194436464"></p>
<ul>
<li><p>进程说明</p>
<ul>
<li><p>Master 进程<br>1、是进行 work 进程的监控管理的<br>2、看看 work 进程是否正常工作需不需要进行热部署、需不需要重新载入配置文件</p>
</li>
<li><p>Cache manager 缓存的管理<br>1、缓存为反向代理后端发来的动态请求做缓存使用</p>
<p>2、缓存在不光是在 work 进程间使用、还要被 Cache manager 和 Cache loader 使用</p>
</li>
<li><p>Cache loader 载入缓存</p>
</li>
</ul>
</li>
<li><p>实例演示</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf]# ps -ef|grep nginx</span><br><span class="line">root      262788       1  0 18:09 ?        00:00:00 nginx: master process ../sbin/nginx</span><br><span class="line">root      262789  262788  0 18:09 ?        00:00:00 nginx: worker process</span><br><span class="line">root      262790  262788  0 18:09 ?        00:00:00 nginx: cache manager process</span><br><span class="line">root      274250  221527  0 19:54 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@ecs conf]# ../sbin/nginx -s reload</span><br><span class="line">[root@ecs conf]# ps -ef|grep nginx</span><br><span class="line">root      262788       1  0 18:09 ?        00:00:00 nginx: master process ../sbin/nginx</span><br><span class="line">root      274252  262788  0 19:54 ?        00:00:00 nginx: worker process</span><br><span class="line">root      274253  262788  0 19:54 ?        00:00:00 nginx: cache manager process</span><br><span class="line">root      274255  221527  0 19:54 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">[root@ecs conf]# kill -SIGHUP 262788</span><br><span class="line">[root@ecs conf]# ps -ef|grep nginx</span><br><span class="line">root      262788       1  0 18:09 ?        00:00:00 nginx: master process ../sbin/nginx</span><br><span class="line">root      274267  262788  0 19:55 ?        00:00:00 nginx: worker process</span><br><span class="line">root      274268  262788  0 19:55 ?        00:00:00 nginx: cache manager process</span><br><span class="line">root      274270  221527  0 19:55 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></tbody></table></figure></li>
</ul>
<ol start="3">
<li><p>使用信号管理 Nginx 的父子进程</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200058.png" alt="image-20210216200057165"></p>
<p>CHLD：终止进程信号。</p>
<p>TERM,INT: 立刻停止进程</p>
<p>QUIT: 优雅停止进程</p>
<p>HUP: 重载配置文件</p>
<p>USR1: 重新打开日志文件</p>
<p>USR2、WINCH: 需要通过命令行结合 kill 命令使用</p>
</li>
<li><p>reload 重载配置文件真相</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222161350.png" alt="image-20210216200509924"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200647.png" alt="image-20210216200645297"></p>
</li>
<li><p>热升级的完整流程</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200814.png" alt="image-20210216200813214"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210216200841.png" alt="image-20210216200839986"></p>
</li>
</ol>
</li>
</ol>
<h1 id="Nginx架构基础-二"><a href="#Nginx架构基础-二" class="headerlink" title="Nginx架构基础(二)"></a>Nginx 架构基础 (二)</h1><ol>
<li><p>网络收发与 Nginx 事件间的对应关系</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160445.png" alt="image-20210219160443138"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160514.png" alt="image-20210219160513587"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219160531.png" alt="image-20210219160530518"></p>
</li>
<li><p>Nginx 网络事件实例演示</p>
<p>抓包工具：<a target="_blank" rel="noopener" href="https://www.wireshark.org/#download">https://www.wireshark.org/#download</a></p>
<ul>
<li><p>TCP 层：本地打开了 54756，Nginx 打开的是 8080 端口 进程与进程通信</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162314.png" alt="image-20210219162313093"></p>
</li>
<li><p>IP 层：本机 IP 地址：192.168.1.196 nginx 服务器的 IP 地址：127.0.0.1</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162425.png" alt="image-20210219162424652"></p>
</li>
<li><p>三次握手</p>
<p>windows 先向 nginx 发送一个 SYN<br>相反的 nginx 所在的 linux 也会向 windos 发送一个 SYN，这个时候 nginx 是没有感知到的、因为这是一个半打开的状态<br>直到 widows 再向 nginx 所在的 linux 服务器发送一个 ACK 时，linux 操作系统才会通知 nginx 这时有一个读事件需要处理</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219162529.png" alt="image-20210219162528218"></p>
</li>
</ul>
</li>
<li><p>epoll 的优劣及原理</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219163038.png" alt="image-20210219163036992"></p>
</li>
</ol>
<h1 id="详解HTTP模块"><a href="#详解HTTP模块" class="headerlink" title="详解HTTP模块"></a>详解 HTTP 模块</h1><ol>
<li><p>冲突的配置指令以谁为准？</p>
<ul>
<li><p>配置块的嵌套</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">http {</span><br><span class="line">        upstream { … }</span><br><span class="line">        split_clients {…}</span><br><span class="line">        map {…}</span><br><span class="line">        geo {…}</span><br><span class="line">        server {</span><br><span class="line">                <span class="keyword">if</span> () {…}</span><br><span class="line">                location {</span><br><span class="line">                        limit_except {…}</span><br><span class="line">                }</span><br><span class="line">                location {</span><br><span class="line">                        location {</span><br><span class="line">                        }</span><br><span class="line">                }</span><br><span class="line">        }</span><br><span class="line">        server {</span><br><span class="line">        }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>指令的 Context</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Syntax:  log_format name [escape=default|json|none] string ...;</span><br><span class="line">Default:  log_format combined "...";</span><br><span class="line">Context:  http</span><br><span class="line"> </span><br><span class="line">Syntax:</span><br><span class="line">access_log path [format [buffer=size] [gzip[=level]] [flush=time] [if=condition]];</span><br><span class="line">access_log off;</span><br><span class="line">Default:  access_log logs/access.log combined;</span><br><span class="line">Context:  http, server, location, if in location, limit_excep</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>指令的合并</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219171227.png" alt="image-20210219171225935"></p>
</li>
<li><p>存储值的指令集成规则：向上覆盖</p>
<p>子配置不存在时，直接使用父配置块；</p>
<p>子配置存在时，直接覆盖父配置块。</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">    listen <span class="number">8080</span>;</span><br><span class="line">    root /home/geek/nginx/html;</span><br><span class="line">    access_log logs/geek.access.log main;</span><br><span class="line">    location /test {</span><br><span class="line">        root /home/geek/nginx/test;</span><br><span class="line">        access_log logs/access.test.log main;</span><br><span class="line">    }</span><br><span class="line">    location /dlib {</span><br><span class="line">        alias dlib/;</span><br><span class="line">    }</span><br><span class="line">    location / {</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>HTTP 模块合并配置的实现</p>
<ul>
<li>指令在哪个块下生效？11 个阶段</li>
<li>指令允许出现在那些块下？</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> { ngx_string("valid_referers"),</span><br><span class="line">      NGX_HTTP_SRV_CONF|NGX_HTTP_LOC_CONF|NGX_CONF_1MORE,</span><br><span class="line">......</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li>在 server 块内生效、从 http 向 server 合并指令：<br><code>char *(*merge_srv_conf)(ngx_conf_t *cf, void *prev, void *conf);</code></li>
<li>配置缓存在内存<br><code>char *(*merge_loc_conf)(ngx_conf_t *cf, void *prev, void *conf);</code></li>
</ul>
</li>
</ul>
</li>
<li><p>Listen 指令</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen unix:/var/run/nginx.sock;</span><br><span class="line">listen 127.0.0.1:8000;</span><br><span class="line">listen 127.0.0.1;</span><br><span class="line">listen 8000;</span><br><span class="line">listen *:8000;</span><br><span class="line">listen localhost:8000 bind;</span><br><span class="line">listen [::]:8000 ipv6only=on;</span><br><span class="line">listen [::1];</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>处理 HTTP 请求头部的流程</p>
<ul>
<li>接收请求事件模块</li>
</ul>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219172505.png" alt="image-20210219172504477"></p>
<ul>
<li><p>接收请求 HTTP 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219172555.png" alt="image-20210219172554657"></p>
</li>
</ul>
</li>
<li><p>如何找到处理请求的 server 指令块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219173023.png" alt="image-20210219173022622"></p>
<ul>
<li><p>server 匹配顺序</p>
<p>1、精确匹配</p>
<p>2、* 在前的泛域名</p>
<p>3、* 在后的泛域名</p>
<p>4、按文件中的顺序匹配正则表达式域名</p>
<p>5、default server</p>
<p>​    第 1 个</p>
<p>​    listen 指定 default</p>
</li>
</ul>
</li>
<li><p>详解 HTTP 请求的 11 个阶段</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174239.png" alt="image-20210219174238372"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174302.png" alt="image-20210219174301234"></p>
<p>参考地址：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/luoahong/p/13542203.html">https://www.cnblogs.com/luoahong/p/13542203.html</a></p>
<p>11 个阶段的顺序处理</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210219174400.png" alt="image-20210219174359347"></p>
<table>
<thead>
<tr>
<th>阶段</th>
<th>使用的模块</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td> POST_READ</td>
<td>realip</td>
<td> 刚读完 http 请求头、没有经过任何加工过、获取到一些原始的值</td>
</tr>
<tr>
<td> SERVER_REWRITE</td>
<td>rewrite</td>
<td> 它和下面 REWRITE 的只有一个模块</td>
</tr>
<tr>
<td> FIND_CONFIG</td>
<td> 这个只有 nginx 框架会做</td>
<td>所以没有任何的模块、就是在做 location 的一个匹配</td>
</tr>
<tr>
<td> REWRITE</td>
<td>rewrite</td>
<td> 一般第三方模块没有一个处理 REWRITE</td>
</tr>
<tr>
<td>POST_REWRITE</td>
<td></td>
<td> 刚刚 REWRITE 之后要做的一些事情</td>
</tr>
<tr>
<td> PREACCESS</td>
<td>limt_conn, limit_req</td>
<td> 在 access 之前要不要做一些工作、 限制速度、 限制连接数</td>
</tr>
<tr>
<td> ACCESS</td>
<td>auth_basic| access|auth_request</td>
<td> 确认访问权限的 能不能访问 | 根据访问的 ip | 根据第三方的服务</td>
</tr>
<tr>
<td> POST_ACCESS</td>
<td></td>
<td></td>
</tr>
<tr>
<td>PRECONFTENT</td>
<td>try_files mirrors</td>
<td> 处理 CONTENT 之前 会把这个服务发送给第三方服务、一个请求产生多个请求值</td>
</tr>
<tr>
<td> CONTENT</td>
<td>index| autoindex|concat</td>
<td> 反向代理</td>
</tr>
<tr>
<td> LOG</td>
<td>access_log</td>
<td> 打印 access 日志的</td>
</tr>
</tbody></table>
</li>
<li><p> postread 阶段：获取真实客户端地址的 realip 模块</p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat realip.conf </span><br><span class="line">server {</span><br><span class="line">	server_name realip.test.com;</span><br><span class="line"></span><br><span class="line">	error_log logs/myerror.log debug;</span><br><span class="line">	set_real_ip_from  127.0.0.1;</span><br><span class="line"><span class="meta">	#</span><span class="bash">real_ip_header X-Real-IP;</span></span><br><span class="line">	real_ip_recursive off;</span><br><span class="line"><span class="meta">	#</span><span class="bash">real_ip_recursive on;</span></span><br><span class="line">	real_ip_header    X-Forwarded-For;</span><br><span class="line"></span><br><span class="line">	location /{</span><br><span class="line">		return 200 "Client real ip: $remote_addr\n";</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试</span></span><br><span class="line">[root@ecs conf.d]# curl -H 'X-Forwarded-For: 1.1.1.1,127.0.0.1' realip.test.com</span><br><span class="line">Client real ip: 127.0.0.1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 开启 real_ip_recursive on;</span></span><br><span class="line">[root@ecs conf.d]# curl -H 'X-Forwarded-For: 1.1.1.1,127.0.0.1' realip.test.com</span><br><span class="line">Client real ip: 1.1.1.1</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>rewrite 阶段的 rewrite 模块：return 指令</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210220095723.png" alt="image-20210220095721052"></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat return.conf </span><br><span class="line">server {</span><br><span class="line">	server_name return.test.com;</span><br><span class="line">	listen 8080;</span><br><span class="line"></span><br><span class="line">	root html/;</span><br><span class="line">	error_page 404 /403.html;</span><br><span class="line"><span class="meta">	#</span><span class="bash"><span class="built_in">return</span> 405;</span></span><br><span class="line">	location /{</span><br><span class="line"><span class="meta">		#</span><span class="bash"><span class="built_in">return</span> 404 <span class="string">"find nothing!\n"</span>;</span></span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">[root@ecs conf.d]# curl return.test.com:8080/aaa.html</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Error&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body {</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    }</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;403 forbidden.&lt;/h1&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 去掉 <span class="built_in">return</span> 404 <span class="string">"find nothing!\n"</span>; 注释</span></span><br><span class="line">[root@ecs conf.d]# curl return.test.com:8080/aaa.html</span><br><span class="line">find nothing!</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 去掉 <span class="built_in">return</span> 405注释</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 说明 <span class="built_in">return</span> 405是在SERVER_REWRITE 阶段，而<span class="built_in">return</span> 404 <span class="string">"find nothing!\n"</span>处于REWRITE，优先处理SERVER_REWRITE</span></span><br><span class="line">[root@ecs conf.d]# curl return.test.com:8080/aaa.html</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;405 Not Allowed&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;405 Not Allowed&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>rewrite 阶段的 rewrite 模块：重写 URL</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210220105242.png" alt="image-20210220105241215"></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat rewrite.conf </span><br><span class="line">server {</span><br><span class="line">	server_name rewrite.test.com;</span><br><span class="line">	rewrite_log on;</span><br><span class="line">	error_log logs/rewrite_error.log notice;</span><br><span class="line"></span><br><span class="line">	root html/;</span><br><span class="line">	location /first {</span><br><span class="line">		rewrite /first(.*) /second$1 last;</span><br><span class="line">		return 200 'first!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /second {</span><br><span class="line"><span class="meta">		#</span><span class="bash">rewrite /second(.*) /third<span class="variable">$1</span> <span class="built_in">break</span>;</span></span><br><span class="line">		rewrite /second(.*) /third$1;</span><br><span class="line">		return 200 'second!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /third {</span><br><span class="line">		return 200 'third!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	location /redirect1 {</span><br><span class="line">		rewrite /redirect1(.*) $1 permanent;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /redirect2 {</span><br><span class="line">		rewrite /redirect2(.*) $1 redirect;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /redirect3 {</span><br><span class="line">                rewrite /redirect3(.*) http://rewrite.test.com$1;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">	location /redirect4 {</span><br><span class="line">                rewrite /redirect4(.*) http://rewrite.test.com$1 permanent;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> 从/first 重定向到 /second rewrite后面没有<span class="built_in">break</span>，依次向下执行</span></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/first/3.txt</span><br><span class="line">second!</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开rewrite /second(.*) /third<span class="variable">$1</span> <span class="built_in">break</span>;</span></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/first/3.txt</span><br><span class="line">test3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 实际访问目录是</span> </span><br><span class="line">[root@ecs conf.d]# cat /usr/local/nginx/html/third/3.txt </span><br><span class="line">test3</span><br><span class="line"></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/redirect1/ -I</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Sat, 20 Feb 2021 03:06:51 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 169</span><br><span class="line">Location: http://rewrite.test.com/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/redirect2/ -I</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Sat, 20 Feb 2021 03:06:57 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Location: http://rewrite.test.com/</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/redirect3/ -I</span><br><span class="line">HTTP/1.1 302 Moved Temporarily</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Sat, 20 Feb 2021 03:07:25 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 145</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http://rewrite.test.com/</span><br><span class="line"></span><br><span class="line">[root@ecs conf.d]# curl rewrite.test.com/redirect4/ -I</span><br><span class="line">HTTP/1.1 301 Moved Permanently</span><br><span class="line">Server: nginx/1.18.0</span><br><span class="line">Date: Sat, 20 Feb 2021 03:07:44 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 169</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Location: http://rewrite.test.com/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过打开的rewrite_log on; 查看日志</span></span><br><span class="line">[root@ecs logs]# cat rewrite_error.log </span><br><span class="line">2021/02/20 11:06:51 [notice] 295965#0: *12 "/redirect1(.*)" matches "/redirect1/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect1/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:06:51 [notice] 295965#0: *12 rewritten redirect: "/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect1/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:06:57 [notice] 295965#0: *13 "/redirect2(.*)" matches "/redirect2/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect2/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:06:57 [notice] 295965#0: *13 rewritten redirect: "/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect2/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:07:25 [notice] 295965#0: *14 "/redirect3(.*)" matches "/redirect3/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect3/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:07:25 [notice] 295965#0: *14 rewritten redirect: "http://rewrite.test.com/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect3/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:07:44 [notice] 295965#0: *15 "/redirect4(.*)" matches "/redirect4/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect4/ HTTP/1.1", host: "rewrite.test.com"</span><br><span class="line">2021/02/20 11:07:44 [notice] 295965#0: *15 rewritten redirect: "http://rewrite.test.com/", client: 127.0.0.1, server: rewrite.test.com, request: "HEAD /redirect4/ HTTP/1.1", host: "rewrite.test.com"</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>rewrite 阶段的 rewrite 模块：条件判断</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210220111129.png" alt="image-20210220111128109"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202101/20210220111153.png" alt="image-20210220111152689"></p>
</li>
<li><p>find_config 阶段：找到处理请求的 location 指令块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220111521.png" alt="image-20210220111520074"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220111636.png" alt="image-20210220111635553"></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat locations.conf </span><br><span class="line">server {</span><br><span class="line">	server_name location.test.com;</span><br><span class="line">	error_log  logs/error.log  debug;</span><br><span class="line"><span class="meta">	#</span><span class="bash">root html/;</span></span><br><span class="line">	default_type text/plain;</span><br><span class="line">	merge_slashes off;</span><br><span class="line">	</span><br><span class="line">	location ~ /Test1/$ {</span><br><span class="line">		return 200 'first regular expressions match!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location ~* /Test1/(\w+)$ {</span><br><span class="line">		return 200 'longest regular expressions match!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location ^~ /Test1/ {</span><br><span class="line">		return 200 'stop regular expressions match!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">        location /Test1/Test2 {</span><br><span class="line">                return 200 'longest prefix string match!\n';</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        location /Test1 {</span><br><span class="line">                return 200 'prefix string match!\n';</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	location = /Test1 {</span><br><span class="line">		return 200 'exact match!\n';</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">[root@ecs conf.d]# curl location.test.com/Test1</span><br><span class="line">exact match!</span><br><span class="line">[root@ecs conf.d]# curl location.test.com/Test1/</span><br><span class="line">stop regular expressions match!</span><br><span class="line">[root@ecs conf.d]# curl location.test.com/Test1/Test2</span><br><span class="line">longest regular expressions match!</span><br><span class="line">[root@ecs conf.d]# curl location.test.com/Test1/Test2/</span><br><span class="line">longest prefix string match!</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>preaccess 阶段：对连接做限制的 limit_conn 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220113227.png" alt="image-20210220113226272"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220113241.png" alt="image-20210220113240479"></p>
<p>限制发生时的日志级别</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_conn_log_level info | notice | warn | error;</span><br><span class="line">Default: limit_conn_log_level error;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></tbody></table></figure>

<p>限制发生时向客户端返回的错误码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_conn_status code;</span><br><span class="line">Default: limit_conn_status 503;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220114939.png" alt="image-20210220114938614"></p>
<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat limit_conn.conf </span><br><span class="line">limit_conn_zone $binary_remote_addr zone=addr:10m;</span><br><span class="line">limit_req_zone $binary_remote_addr zone=one:10m rate=2r/m;</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">	server_name limit.test.com;</span><br><span class="line">	root html/;</span><br><span class="line">	error_log logs/myerror.log info;</span><br><span class="line">	</span><br><span class="line">	location /{</span><br><span class="line">		limit_conn_status 500; #返回错误码500</span><br><span class="line">		limit_conn_log_level  warn;</span><br><span class="line">		limit_rate 50; #限制每秒钟向用户返回50Byte</span><br><span class="line">		limit_conn addr 1;  #限制并发连接数1</span><br><span class="line"><span class="meta">		#</span><span class="bash">limit_req zone=one burst=3 nodelay;</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">limit_req zone=one;</span></span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打印错误日志</span></span><br><span class="line">2021/02/20 13:40:08 [info] 296750#0: *45 client 127.0.0.1 closed keepalive connection</span><br><span class="line">2021/02/20 13:40:13 [warn] 296750#0: *47 limiting connections by zone "addr", client: 127.0.0.1, server: limit.test.com, request: "GET / HTTP/1.1", host: "limit.test.com"</span><br><span class="line">2021/02/20 13:40:17 [info] 296750#0: *46 client prematurely closed connection while sending response to client, client: 127.0.0.1, server: limit.test.com, request: "GET / HTTP/1.1", host: "limit.test.com"</span><br><span class="line">2021/02/20 13:40:26 [warn] 296750#0: *49 limiting connections by zone "addr", client: 127.0.0.1, server: limit.test.com, request: "GET / HTTP/1.1", host: "limit.test.com"</span><br><span class="line">2021/02/20 13:40:34 [info] 296750#0: *48 client 127.0.0.1 closed keepalive connection</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>preaccess 阶段：对请求做限制的 limit_req 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220134608.png" alt="image-20210220134607600"></p>
<p>限制发生时的日志级别</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_req_log_level info | notice | warn | error;</span><br><span class="line">Default: limit_req_log_level error;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></tbody></table></figure>

<p>限制发生时向客户端返回的错误码</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: limit_req_status code;</span><br><span class="line">Default: limit_req_status 503;</span><br><span class="line">Context: http, server, location</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">[root@ecs conf.d]# cat limit_conn.conf </span><br><span class="line">limit_conn_zone $binary_remote_addr zone=addr:10m;</span><br><span class="line">limit_req_zone $binary_remote_addr zone=one:10m rate=2r/m;</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">	server_name limit.test.com;</span><br><span class="line">	root html/;</span><br><span class="line">	error_log logs/myerror.log info;</span><br><span class="line">	</span><br><span class="line">	location /{</span><br><span class="line">		limit_conn_status 500;</span><br><span class="line">		limit_conn_log_level  warn;</span><br><span class="line"><span class="meta">		#</span><span class="bash">limit_rate 50;</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">limit_conn addr 1;</span></span><br><span class="line"><span class="meta">		#</span><span class="bash">limit_req zone=one burst=3 nodelay;</span></span><br><span class="line">		limit_req zone=one;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">[root@ecs conf.d]# ../../sbin/nginx -s reload</span><br><span class="line"><span class="meta">#</span><span class="bash">第一次访问正常</span></span><br><span class="line">[root@ecs conf.d]# curl limit.test.com</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body {</span><br><span class="line">        width: 35em;</span><br><span class="line">        margin: 0 auto;</span><br><span class="line">        font-family: Tahoma, Verdana, Arial, sans-serif;</span><br><span class="line">    }</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;If you see this page, the nginx web server is successfully installed and</span><br><span class="line">working. Further configuration is required.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;For online documentation and support please refer to</span><br><span class="line">&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash">第二次返回503</span></span><br><span class="line">[root@ecs conf.d]# curl limit.test.com</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/1.18.0&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 打开 limit_req zone=one burst=3 nodelay; 之后，访问3次正常，第四次返回503</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时打开limit_conn 和 limit_req，返回503，limit_req访问在前。</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>access 阶段：对 ip 做限制的 access 模块</p>
<p>如何限制某些 IP 地址的访问权限。</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220135654.png" alt="image-20210220135653450"></p>
</li>
<li><p>access 阶段：对用户名密码做限制的 auth_basic 模块</p>
<p>auth_basic 模块指令：</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220135932.png" alt="image-20210220135930926"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装工具包</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> ~]<span class="comment"># yum install httpd-tools -y</span></span><br><span class="line"><span class="comment"># 生成文件</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># htpasswd -c auth.pass temp</span></span><br><span class="line">New password: </span><br><span class="line">Re<span class="literal">-type</span> new password: </span><br><span class="line">Adding password <span class="keyword">for</span> user temp</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>access 阶段：使用第三方做权限控制的 auth_request 模块</p>
<p>重新编译安装</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># cd sbin/</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">sbin</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">15724</span></span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">5833272</span> Feb <span class="number">20</span> <span class="number">09</span>:<span class="number">43</span> nginx</span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">5130480</span> Feb <span class="number">16</span> <span class="number">10</span>:<span class="number">32</span> nginx.<span class="number">2</span>.old</span><br><span class="line"><span class="literal">-rwxr</span><span class="literal">-xr</span><span class="literal">-x</span> <span class="number">1</span> root root <span class="number">5130480</span> Feb <span class="number">16</span> <span class="number">10</span>:<span class="number">26</span> nginx.old</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">sbin</span>]<span class="comment"># mv nginx nginx.3.old</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>-<span class="number">1.18</span><span class="type">.0</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>-<span class="number">1.18</span><span class="type">.0</span>]<span class="comment"># make #切勿执行make install</span></span><br><span class="line"><span class="comment">#将objs下的nginx复制到安装目录</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">objs</span>]<span class="comment"># cp nginx /usr/local/nginx/sbin/</span></span><br><span class="line"><span class="comment">#热部署</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>-<span class="number">1.18</span><span class="type">.0</span>]<span class="comment"># kill -USR2 300175</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight shell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">server {</span><br><span class="line">	server_name access.test.com;</span><br><span class="line">	error_log  logs/error.log  debug;</span><br><span class="line"><span class="meta">	#</span><span class="bash">root html/;</span></span><br><span class="line">	default_type text/plain;</span><br><span class="line">	location /auth_basic {</span><br><span class="line">		satisfy any;</span><br><span class="line">		auth_basic "test auth_basic";</span><br><span class="line">		auth_basic_user_file conf.d/auth.pass;</span><br><span class="line">		deny all;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location / {</span><br><span class="line">	   auth_request /test_auth;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location = /test_auth {</span><br><span class="line">		proxy_pass http://127.0.0.1:8090/auth_upstream;</span><br><span class="line">		proxy_pass_request_body off;</span><br><span class="line">    		proxy_set_header Content-Length "";</span><br><span class="line">    		proxy_set_header X-Original-URI $request_uri;</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>access 阶段的 satisfy 指令</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220144002.png" alt="image-20210220144001826"></p>
<ul>
<li><p>如果有 return 指令，access 阶段会生效吗？</p>
<p>不会生效，因为 return 指令在 SERVER_REWRITE 和 REWRITE 阶段，领先于 access。</p>
</li>
<li><p>多个 access 模块的顺序有影响吗？</p>
<p>查看 ngx-modules.c</p>
<p>&amp;ngx_http_auth_request_module,</p>
<p>&amp;ngx_http_auth_basic_module</p>
<p>&amp;ngx_http_access_module</p>
<p>有影响</p>
</li>
<li><p>输对密码，下面可以访问到文件吗？可以</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location/{</span><br><span class="line">    satisfy any;</span><br><span class="line">    auth_basic <span class="string">"test auth basic"</span></span><br><span class="line">    auth_basic_user_file examples/auth.pass;</span><br><span class="line">    deny all:</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>如果把 deny all 提到 auth basic 之前呢？</p>
<p>可以，和指令顺序无关，主要取决于模块顺序。</p>
</li>
<li><p>如果改为 allow all, 有机会输入密码吗？</p>
<p>没有，因为配置的 satisfy any; 只要有一个模块放行即可。而且 allow 属于 access, 先于 auth_basic 执行。</p>
</li>
</ul>
</li>
<li><p>precontent 阶段：按序访问资源的 try_files 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220145725.png" alt="image-20210220145724664"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat tryfiles.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name tryfiles.test.com;</span><br><span class="line">	error_log  logs/myerror.log  info;</span><br><span class="line">	root html/;</span><br><span class="line">	default_type text/plain;</span><br><span class="line">	</span><br><span class="line">	location /first {</span><br><span class="line">    		try_files /system/maintenance.html</span><br><span class="line">              		<span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html</span><br><span class="line">              		@lasturl;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location @lasturl {</span><br><span class="line">    		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'lasturl!\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /second {</span><br><span class="line">		try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/index.html <span class="variable">$uri</span>.html =<span class="number">404</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl tryfiles.test.com/first</span></span><br><span class="line">lasturl!</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl tryfiles.test.com/second</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">404</span> Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">404</span> Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>实时拷贝流量：precontent 阶段的 mirror 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220145826.png" alt="image-20210220145825406"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 本地服务</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat mirror.conf </span></span><br><span class="line">server {</span><br><span class="line">	listen <span class="number">10020</span>;</span><br><span class="line">	location / {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'mirror response!'</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">#上游服务</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf</span>]<span class="comment"># vim mirror.conf</span></span><br><span class="line">server{</span><br><span class="line">	listen <span class="number">8001</span>;</span><br><span class="line">    error_log Logs/error. log debug;</span><br><span class="line">    location / {</span><br><span class="line">        mirror /mirror;</span><br><span class="line">        mirror request _body off;</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    location =/mirror {</span><br><span class="line">        internal;</span><br><span class="line">        proxy_pass http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">10020</span><span class="variable">$request_uri</span>;</span><br><span class="line">        proxy_pass_request_body off;</span><br><span class="line">        proxy_set_header Content<span class="literal">-Length</span> <span class="string">""</span>;</span><br><span class="line">        proxy_set_header X<span class="literal">-Oriqinal</span><span class="literal">-URI</span> <span class="variable">$request_uri</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>content 阶段：详解 root 和 alias 指令</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220151044.png" alt="image-20210220151043106"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat static.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name static.test.com;</span><br><span class="line">	error_log  logs/myerror.log  info;</span><br><span class="line">	</span><br><span class="line">	location /root {</span><br><span class="line">		root html;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /alias {</span><br><span class="line">    		alias html;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location ~ /root/(\w+\.txt) {</span><br><span class="line">		root html/first/<span class="variable">$1</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location ~ /alias/(\w+\.txt) {</span><br><span class="line">		alias html/first/<span class="variable">$1</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location  /RealPath/ {</span><br><span class="line">		alias html/realpath/;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span> <span class="string">'$request_filename:$document_root:$realpath_root\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl static.test.com/root/</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">404</span> Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">404</span> Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="comment"># 日志信息</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">02</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">13</span>:<span class="number">46</span> [<span class="type">error</span>] <span class="number">300277</span><span class="comment">#0: *5 "/usr/local/nginx/html/root/index.html" is not found (2: No such file or directory), client: 127.0.0.1, server: static.test.com, request: "GET /root/ HTTP/1.1", host: "static.test.com"</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl static.test.com/root/1.txt</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">404</span> Not Found&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">404</span> Not Found&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志信息</span></span><br><span class="line"><span class="number">2021</span>/<span class="number">02</span>/<span class="number">20</span> <span class="number">15</span>:<span class="number">15</span>:<span class="number">09</span> [<span class="type">error</span>] <span class="number">300277</span><span class="comment">#0: *7 open() "/usr/local/nginx/html/first/1.txt/root/1.txt" failed (20: Not a directory), client: 127.0.0.1, server: static.test.com, request: "GET /root/1.txt HTTP/1.1", host: "static.test.com"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl static.test.com/alias/</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line">&lt;style&gt;</span><br><span class="line">    body {</span><br><span class="line">        width: <span class="number">35</span>em;</span><br><span class="line">        margin: <span class="number">0</span> auto;</span><br><span class="line">        font<span class="literal">-family</span>: Tahoma, Verdana, Arial, sans<span class="literal">-serif</span>;</span><br><span class="line">    }</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl static.test.com/alias/1.txt</span></span><br><span class="line">test1</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>static 模块提供的 3 个变量</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220151852.png" alt="image-20210220151851113"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 建立软连接</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">html</span>]<span class="comment"># ln -s first realpath</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">html</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">352</span></span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">242</span> Feb <span class="number">20</span> <span class="number">10</span>:<span class="number">05</span> <span class="number">403</span>.html</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">494</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> <span class="number">50</span>x.html</span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span> <span class="number">2</span> root root     <span class="number">32</span> Feb <span class="number">20</span> <span class="number">15</span>:<span class="number">23</span> first</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root    <span class="number">612</span> Feb <span class="number">16</span> <span class="number">09</span>:<span class="number">55</span> index.html</span><br><span class="line">lrwxrwxrwx <span class="number">1</span> root root      <span class="number">5</span> Feb <span class="number">20</span> <span class="number">15</span>:<span class="number">23</span> realpath -&gt; first</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>-- <span class="number">1</span> root root <span class="number">344328</span> Feb <span class="number">16</span> <span class="number">17</span>:<span class="number">55</span> report.html</span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span> <span class="number">2</span> root root     <span class="number">19</span> Feb <span class="number">20</span> <span class="number">10</span>:<span class="number">59</span> second</span><br><span class="line">drwxr<span class="literal">-xr</span><span class="literal">-x</span> <span class="number">2</span> root root     <span class="number">19</span> Feb <span class="number">20</span> <span class="number">10</span>:<span class="number">59</span> third</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">html</span>]<span class="comment"># pwd</span></span><br><span class="line">/usr/local/nginx/html</span><br><span class="line"></span><br><span class="line">location  /RealPath/ {</span><br><span class="line">		alias html/realpath/;</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span> <span class="string">'$request_filename:$document_root:$realpath_root\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl static.test.com/RealPath/1.txt</span></span><br><span class="line">/usr/local/nginx/html/realpath/<span class="number">1</span>.txt:/usr/local/nginx/html/realpath/:/usr/local/nginx/html/first</span><br></pre></td></tr></tbody></table></figure>

<ul>
<li><p>静态文件返回时的 content-type</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220152722.png" alt="image-20210220152721793"></p>
</li>
<li><p>未找到文件时的错误日志</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220152733.png" alt="image-20210220152732954"></p>
</li>
</ul>
</li>
<li><p>static 模块对 url 不以斜杠结尾却访问目录的做法</p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat dirredirect.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name return.test.com dir.test.com;</span><br><span class="line">	server_name_in_redirect off;</span><br><span class="line">	listen <span class="number">8088</span>;</span><br><span class="line">	port_in_redirect on;</span><br><span class="line">	absolute_redirect off;</span><br><span class="line"></span><br><span class="line">	root html/;</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl localhost:8088/first -I</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Server: nginx/<span class="number">1.18</span>.<span class="number">0</span></span><br><span class="line">Date: Sat, <span class="number">20</span> Feb <span class="number">2021</span> <span class="number">07</span>:<span class="number">31</span>:<span class="number">28</span> GMT</span><br><span class="line">Content<span class="literal">-Type</span>: text/html</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">169</span></span><br><span class="line">Connection: keep<span class="literal">-alive</span></span><br><span class="line">Location: /first/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加注释 absolute_redirect off</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl localhost:8088/first -I</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Server: nginx/<span class="number">1.18</span>.<span class="number">0</span></span><br><span class="line">Date: Sat, <span class="number">20</span> Feb <span class="number">2021</span> <span class="number">07</span>:<span class="number">40</span>:<span class="number">40</span> GMT</span><br><span class="line">Content<span class="literal">-Type</span>: text/html</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">169</span></span><br><span class="line">Location: http://localhost:<span class="number">8088</span>/first/</span><br><span class="line">Connection: keep<span class="literal">-alive</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Host:aaa' localhost:8088/first -I</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Server: nginx/<span class="number">1.18</span>.<span class="number">0</span></span><br><span class="line">Date: Sat, <span class="number">20</span> Feb <span class="number">2021</span> <span class="number">07</span>:<span class="number">41</span>:<span class="number">24</span> GMT</span><br><span class="line">Content<span class="literal">-Type</span>: text/html</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">169</span></span><br><span class="line">Location: http://aaa:<span class="number">8088</span>/first/</span><br><span class="line">Connection: keep<span class="literal">-alive</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改 server_name_in_redirect on 返回server_name中的域名</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Host:aaa' localhost:8088/first -I</span></span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">301</span> Moved Permanently</span><br><span class="line">Server: nginx/<span class="number">1.18</span>.<span class="number">0</span></span><br><span class="line">Date: Sat, <span class="number">20</span> Feb <span class="number">2021</span> <span class="number">07</span>:<span class="number">42</span>:<span class="number">15</span> GMT</span><br><span class="line">Content<span class="literal">-Type</span>: text/html</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">169</span></span><br><span class="line">Location: http://return.test.com:<span class="number">8088</span>/first/</span><br><span class="line">Connection: keep<span class="literal">-alive</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>index 和 autoindex 模块的用法</p>
<ul>
<li><p>对访问 / 时的处理：content 阶段的 index 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155144.png" alt="image-20210220155143765"></p>
</li>
<li><p>随机 index.html 文件：content 阶段的 autoindex 模块</p>
<p><img src="C:%5CUsers%5CAdministrator%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20210220155228796.png" alt="image-20210220155228796"></p>
</li>
<li><p>显示目录内容：content 阶段的 autoindex 模块</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155334.png" alt="image-20210220155333189"></p>
</li>
<li><p>autoindex 模块的指令</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220155501.png" alt="image-20210220155500362"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat autoindex.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name autoindex.test.com;</span><br><span class="line">	listen <span class="number">8080</span>;</span><br><span class="line">	location / {</span><br><span class="line">		alias html/;</span><br><span class="line">		autoindex on;</span><br><span class="line">		<span class="comment">#index a.html;</span></span><br><span class="line">		autoindex_exact_size off;</span><br><span class="line">		autoindex_format html;</span><br><span class="line">		autoindex_localtime on;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl autoindex.test.com:8080</span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Welcome to nginx!&lt;/title&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ****** 以html的形式显示文件目录 ******</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat autoindex.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name autoindex.test.com;</span><br><span class="line">	listen <span class="number">8080</span>;</span><br><span class="line">	location / {</span><br><span class="line">		alias html/;</span><br><span class="line">		autoindex on;</span><br><span class="line">		index a.html;</span><br><span class="line">		autoindex_exact_size off;</span><br><span class="line">		autoindex_format html;</span><br><span class="line">		autoindex_localtime on;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># ../../sbin/nginx -s reload</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl autoindex.test.com:8080</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;Index of /&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Index of /&lt;/h1&gt;&lt;hr&gt;&lt;pre&gt;&lt;a href=<span class="string">"../"</span>&gt;../&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">"first/"</span>&gt;first/&lt;/a&gt;                                             <span class="number">20</span><span class="literal">-Feb</span><span class="literal">-2021</span> <span class="number">15</span>:<span class="number">23</span>       -</span><br><span class="line">&lt;a href=<span class="string">"realpath/"</span>&gt;realpath/&lt;/a&gt;                                          <span class="number">20</span><span class="literal">-Feb</span><span class="literal">-2021</span> <span class="number">15</span>:<span class="number">23</span>       -</span><br><span class="line">&lt;a href=<span class="string">"second/"</span>&gt;second/&lt;/a&gt;                                            <span class="number">20</span><span class="literal">-Feb</span><span class="literal">-2021</span> <span class="number">10</span>:<span class="number">59</span>       -</span><br><span class="line">&lt;a href=<span class="string">"third/"</span>&gt;third/&lt;/a&gt;                                             <span class="number">20</span><span class="literal">-Feb</span><span class="literal">-2021</span> <span class="number">10</span>:<span class="number">59</span>       -</span><br><span class="line">&lt;a href=<span class="string">"403.html"</span>&gt;<span class="number">403</span>.html&lt;/a&gt; </span><br></pre></td></tr></tbody></table></figure></li>
</ul>
</li>
<li><p>提升多个小文件性能的 concat 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220160244.png" alt="image-20210220160243581"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装concat模块</span></span><br><span class="line">git clone git://github.com/alibaba/nginx<span class="literal">-http</span><span class="literal">-concat</span>.git</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module --add-module=/data/soft/nginx/nginx-http-concat</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat concat.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name concat.test.com;</span><br><span class="line"></span><br><span class="line">	error_log logs/myerror.log debug;</span><br><span class="line">	concat on;</span><br><span class="line">	root html;</span><br><span class="line">	</span><br><span class="line">        location /concat {</span><br><span class="line">		concat_max_files <span class="number">20</span>;</span><br><span class="line">		concat_types text/plain;</span><br><span class="line">		concat_unique on;</span><br><span class="line">		concat_delimiter <span class="string">':::'</span>;</span><br><span class="line">		concat_ignore_file_error on;</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl concat.test.com/concat/??1.txt,2.txt</span></span><br><span class="line">test1</span><br><span class="line">:::test2</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>access 日志的详细用法   </p>
<ul>
<li><p>access 日志格式</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163040.png" alt="image-20210220163039376"></p>
</li>
<li><p>配置日志文件路径</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163110.png" alt="image-20210220163109724"></p>
</li>
<li><p>对日志文件名包含变量时的优化</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163148.png" alt="image-20210220163147343"></p>
</li>
</ul>
</li>
<li><p>HTTP 过滤模块的调用流程   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163541.png" alt="image-20210220163539880"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163658.png" alt="image-20210220163657268"></p>
</li>
<li><p>用过滤模块更改响应中的字符串：sub 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163739.png" alt="image-20210220163738030"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220163753.png" alt="image-20210220163752610"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加模块</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module --add-module=/data/soft/nginx/nginx-http-concat --with-http_sub_module</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat sub.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name sub.test.com;</span><br><span class="line">	error_log  logs/myerror.log  info;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">    		<span class="comment">#sub_filter 'Nginx.oRg'  '$host/nginx';</span></span><br><span class="line">    		<span class="comment">#sub_filter 'nginX.cOm' '$host/nginx';</span></span><br><span class="line">    		<span class="comment">#sub_filter_once on;</span></span><br><span class="line">		<span class="comment">#sub_filter_once off;</span></span><br><span class="line">		<span class="comment">#sub_filter_last_modified off;</span></span><br><span class="line">		<span class="comment">#sub_filter_last_modified on;</span></span><br><span class="line">	}	</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl sub.test.com</span></span><br><span class="line">&lt;a href=<span class="string">"http://nginx.org/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://nginx.com/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> <span class="keyword">using</span> nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#进行替换</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat sub.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name sub.test.com;</span><br><span class="line">	error_log  logs/myerror.log  info;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">    		sub_filter <span class="string">'Nginx.oRg'</span>  <span class="string">'$host/nginx'</span>;</span><br><span class="line">    		sub_filter <span class="string">'nginX.cOm'</span> <span class="string">'$host/nginx'</span>;</span><br><span class="line">    		sub_filter_once on;</span><br><span class="line">		<span class="comment">#sub_filter_once off;</span></span><br><span class="line">		sub_filter_last_modified off;</span><br><span class="line">		<span class="comment">#sub_filter_last_modified on;</span></span><br><span class="line">	}	</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl sub.test.com</span></span><br><span class="line">&lt;a href=<span class="string">"http://sub.test.com/nginx/"</span>&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://sub.test.com/nginx/"</span>&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br><span class="line">&lt;p&gt;&lt;em&gt;Thank you <span class="keyword">for</span> <span class="keyword">using</span> nginx.&lt;/em&gt;&lt;/p&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全部替换</span></span><br><span class="line">location / {</span><br><span class="line">    		sub_filter <span class="string">'Nginx.oRg'</span>  <span class="string">'$host/nginx'</span>;</span><br><span class="line">    		sub_filter <span class="string">'nginX.cOm'</span> <span class="string">'$host/nginx'</span>;</span><br><span class="line">    		<span class="comment">#sub_filter_once on;</span></span><br><span class="line">		sub_filter_once off;</span><br><span class="line">		<span class="comment">#sub_filter_last_modified off;</span></span><br><span class="line">		sub_filter_last_modified on;</span><br><span class="line">	}	</span><br><span class="line">	</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl sub.test.com	</span></span><br><span class="line">&lt;p&gt;<span class="keyword">For</span> online documentation and support please refer to</span><br><span class="line">&lt;a href=<span class="string">"http://sub.test.com/nginx/"</span>&gt;sub.test.com/nginx&lt;/a&gt;.&lt;br/&gt;</span><br><span class="line">Commercial support is available at</span><br><span class="line">&lt;a href=<span class="string">"http://sub.test.com/nginx/"</span>&gt;sub.test.com/nginx&lt;/a&gt;.&lt;/p&gt;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>用过滤模块在 http 响应的前后添加内容：addition 模块  </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165321.png" alt="image-20210220165320179"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165105.png" alt="image-20210220165104305"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加模块</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module --add-module=/data/soft/nginx/nginx-http-concat --with-http_sub_module --with-http_addition_module</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat addition.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name addition.test.com;</span><br><span class="line">	error_log logs/myerror.log info;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">    		add_before_body /before_action;</span><br><span class="line">    		add_after_body  /after_action;</span><br><span class="line">		addition_types *;</span><br><span class="line">	}	</span><br><span class="line">	location /before_action {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'new content before\n'</span>;</span><br><span class="line">	}</span><br><span class="line">	location /after_action {</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'new content after\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /testhost {</span><br><span class="line">		uninitialized_variable_warn on;</span><br><span class="line">		<span class="built_in">set</span> <span class="variable">$foo</span> <span class="string">'testhost'</span>;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'$gzip_ratio\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl addition.test.com/a.txt</span></span><br><span class="line">new content before</span><br><span class="line">aaa</span><br><span class="line">new content after</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>Nginx 变量的运行原理   </p>
<ul>
<li><p>变量的惰性求值</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220165958.png" alt="image-20210220165957254"></p>
</li>
<li><p>变量的特性</p>
<ul>
<li><p>惰性求值</p>
</li>
<li><p>变量值可以时刻变化，其值为使用时的那一刻的值</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>HTTP 框架提供的请求相关的变量   </p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat var.conf </span></span><br><span class="line">log_format  vartest  <span class="string">'$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status bytes_sent=$bytes_sent body_bytes_sent=$body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$sent_http_abc"'</span>;</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">	server_name var.test.com localhost;</span><br><span class="line">	<span class="comment">#error_log logs/myerror.log debug;</span></span><br><span class="line">	access_log logs/vartest.log vartest;</span><br><span class="line">	listen <span class="number">9090</span>;</span><br><span class="line">	</span><br><span class="line">	location / {</span><br><span class="line">		<span class="built_in">set</span> <span class="variable">$limit_rate</span> <span class="number">10</span>k;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'</span></span><br><span class="line"><span class="string">arg_a: $arg_a,arg_b: $arg_b,args: $args</span></span><br><span class="line"><span class="string">connection: $connection,connection_requests: $connection_requests</span></span><br><span class="line"><span class="string">cookie_a: $cookie_a</span></span><br><span class="line"><span class="string">uri: $uri,document_uri: $document_uri, request_uri: $request_uri</span></span><br><span class="line"><span class="string">request: $request</span></span><br><span class="line"><span class="string">request_id: $request_id</span></span><br><span class="line"><span class="string">server: $server_addr,$server_name,$server_port,$server_protocol</span></span><br><span class="line"><span class="string">tcpinfo:  $tcpinfo_rtt, $tcpinfo_rttvar, $tcpinfo_snd_cwnd, $tcpinfo_rcv_space </span></span><br><span class="line"><span class="string">host: $host,server_name: $server_name,http_host: $http_host</span></span><br><span class="line"><span class="string">limit_rate: $limit_rate</span></span><br><span class="line"><span class="string">hostname: $hostname</span></span><br><span class="line"><span class="string">content_length: $content_length</span></span><br><span class="line"><span class="string">status: $status</span></span><br><span class="line"><span class="string">body_bytes_sent: $body_bytes_sent,bytes_sent: $bytes_sent</span></span><br><span class="line"><span class="string">time: $request_time,$msec,$time_iso8601,$time_local</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">	}	</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Content-Length: 0' -H 'Cookie: a=c1' 'localhost:9090?a=1&amp;b=22'</span></span><br><span class="line"></span><br><span class="line">arg_a: <span class="number">1</span>,arg_b: <span class="number">22</span>,args: a=<span class="number">1</span>&amp;b=<span class="number">22</span></span><br><span class="line">connection: <span class="number">4</span>,connection_requests: <span class="number">1</span></span><br><span class="line">cookie_a: c1</span><br><span class="line">uri: /,document_uri: /, request_uri: /?a=<span class="number">1</span>&amp;b=<span class="number">22</span></span><br><span class="line">request: GET /?a=<span class="number">1</span>&amp;b=<span class="number">22</span> HTTP/<span class="number">1.1</span></span><br><span class="line">request_id: <span class="number">00</span>c17d3d3fe9a07a362e7709ef28aab9</span><br><span class="line">server: <span class="number">127.0</span>.<span class="number">0.1</span>,var.test.com,<span class="number">9090</span>,HTTP/<span class="number">1.1</span></span><br><span class="line">tcpinfo:  <span class="number">12</span>, <span class="number">6</span>, <span class="number">10</span>, <span class="number">43690</span> </span><br><span class="line">host: localhost,server_name: var.test.com,http_host: localhost:<span class="number">9090</span></span><br><span class="line">limit_rate: <span class="number">10240</span></span><br><span class="line">hostname: ecs</span><br><span class="line">content_length: <span class="number">0</span></span><br><span class="line">status: <span class="number">200</span></span><br><span class="line">body_bytes_sent: <span class="number">0</span>,bytes_sent: <span class="number">0</span></span><br><span class="line">time: <span class="number">0.000</span>,<span class="number">1613812049.725</span>,<span class="number">2021</span><span class="literal">-02</span><span class="literal">-20T17</span>:<span class="number">07</span>:<span class="number">29</span>+<span class="number">08</span>:<span class="number">00</span>,<span class="number">20</span>/Feb/<span class="number">2021</span>:<span class="number">17</span>:<span class="number">07</span>:<span class="number">29</span> +<span class="number">0800</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>HTTP 框架提供的其他变量   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171006.png" alt="image-20210220171005344"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171019.png" alt="image-20210220171017970"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171027.png" alt="image-20210220171026325"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171036.png" alt="image-20210220171035536"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171050.png" alt="image-20210220171048990"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171105.png" alt="image-20210220171104655"></p>
</li>
<li><p>使用变量防盗链的 referer 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171330.png" alt="image-20210220171329363"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220171402.png" alt="image-20210220171401234"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat referer.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name referer.test.com;</span><br><span class="line"></span><br><span class="line">	error_log logs/myerror.log debug;</span><br><span class="line">	root html;</span><br><span class="line">	location /{</span><br><span class="line">		valid_referers none blocked server_names</span><br><span class="line">               		*.test.pub www.test.org.cn/nginx/</span><br><span class="line">               		~\.google\.;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="variable">$invalid_referer</span>) {</span><br><span class="line">    			<span class="keyword">return</span> <span class="number">403</span>;</span><br><span class="line">		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'valid\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://www.test.org.cn/ttt' referer.test.com/</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://www.test.pub/ttt' referer.test.com/</span></span><br><span class="line">valid</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: ' referer.test.com/</span></span><br><span class="line">valid</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl referer.test.com/</span></span><br><span class="line">valid</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://www.test.com' referer.test.com/</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://referer.test.com' referer.test.com/</span></span><br><span class="line">valid</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://image.baidu.com/search/detail' referer.test.com/</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'referer: http://image.google.com/search/detail' referer.test.com/</span></span><br><span class="line">valid</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>使用变量实现防盗链功能实践：secure_link 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220172816.png" alt="image-20210220172815652"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加模块</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module --add-module=/data/soft/nginx/nginx-http-concat --with-http_sub_module --with-http_addition_module --with-http_secure_link_module</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat secure_link.conf </span></span><br><span class="line">server {</span><br><span class="line">	server_name securelink.test.com;</span><br><span class="line">	error_log  logs/myerror.log  info;</span><br><span class="line">	default_type text/plain;</span><br><span class="line">	location /{</span><br><span class="line">		secure_link <span class="variable">$arg_md5</span>,<span class="variable">$arg_expires</span>;</span><br><span class="line">    		secure_link_md5 <span class="string">"<span class="variable">$secure_link_expires</span><span class="variable">$uri</span><span class="variable">$remote_addr</span> secret"</span>;</span><br><span class="line"></span><br><span class="line">    		<span class="keyword">if</span> (<span class="variable">$secure_link</span> = <span class="string">""</span>) {</span><br><span class="line">        		<span class="keyword">return</span> <span class="number">403</span>;</span><br><span class="line">    		}</span><br><span class="line"></span><br><span class="line">    		<span class="keyword">if</span> (<span class="variable">$secure_link</span> = <span class="string">"0"</span>) {</span><br><span class="line">        		<span class="keyword">return</span> <span class="number">410</span>;</span><br><span class="line">    		}</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'$secure_link:$secure_link_expires\n'</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /p/ {</span><br><span class="line">    		secure_link_secret mysecret2;</span><br><span class="line"></span><br><span class="line">    		<span class="keyword">if</span> (<span class="variable">$secure_link</span> = <span class="string">""</span>) {</span><br><span class="line">        		<span class="keyword">return</span> <span class="number">403</span>;</span><br><span class="line">    		}</span><br><span class="line"></span><br><span class="line">    		rewrite ^ /secure/<span class="variable">$secure_link</span>;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">	location /secure/ {</span><br><span class="line">		alias html/;</span><br><span class="line">    		internal;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"><span class="comment"># 生成hash摘要</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># echo -n '52656565776/test1.txt127.0.0.1 secret' | openssl md5 -binary | openssl base64 | tr +/ - | tr -d =</span></span><br><span class="line">FQuWy7wgjy9V8yLg7M7ZoA</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl 'securelink.test.com/test1.txt?md5=FQuWy7wgjy9V8yLg7M7Zo&amp;expires=52656565776'</span></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;&lt;title&gt;<span class="number">403</span> Forbidden&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;center&gt;&lt;h1&gt;<span class="number">403</span> Forbidden&lt;/h1&gt;&lt;/center&gt;</span><br><span class="line">&lt;hr&gt;&lt;center&gt;nginx/<span class="number">1.18</span>.<span class="number">0</span>&lt;/center&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl 'securelink.test.com/test1.txt?md5=FQuWy7wgjy9V8yLg7M7ZoA&amp;expires=52656565776'</span></span><br><span class="line"><span class="number">1</span>:<span class="number">52656565776</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># echo -n 'test1.txtmysecret2' | openssl md5 -hex</span></span><br><span class="line">(stdin)= c3f9b32bf901b04c052ea9511e29a918</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl 'securelink.test.com/p/c3f9b32bf901b04c052ea9511e29a918/test1.txt'</span></span><br><span class="line"><span class="number">1111</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>为复杂的业务生成新的变量：map 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220174902.png" alt="image-20210220174901693"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat map.conf </span></span><br><span class="line">map <span class="variable">$http_host</span> <span class="variable">$name</span> {</span><br><span class="line">    hostnames;</span><br><span class="line"></span><br><span class="line">    default       <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    ~map\.test\w+\.org.cn <span class="number">1</span>;</span><br><span class="line">    *.test.org.cn   <span class="number">2</span>;</span><br><span class="line">    map.test.com   <span class="number">3</span>;</span><br><span class="line">    map.test.*    <span class="number">4</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">map <span class="variable">$http_user_agent</span> <span class="variable">$mobile</span> {</span><br><span class="line">    default       <span class="number">0</span>;</span><br><span class="line">    <span class="string">"~Opera Mini"</span> <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Host: map.test.com' 127.0.0.1:10001</span></span><br><span class="line"><span class="number">3</span>:<span class="number">0</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Host: map.test.org.cn' 127.0.0.1:10001</span></span><br><span class="line"><span class="number">2</span>:<span class="number">0</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'Host: map.test123.org.cn' 127.0.0.1:10001</span></span><br><span class="line"><span class="number">1</span>:<span class="number">0</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>通过变量指定少量用户实现 AB 测试：split_client 模块  </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220174923.png" alt="image-20210220174922875"> </p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat map.conf </span></span><br><span class="line">server {</span><br><span class="line">	listen <span class="number">10001</span>;</span><br><span class="line">	default_type text/plain;</span><br><span class="line">	location /{</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'$name:$mobile\n'</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">split_clients <span class="string">"<span class="variable">$</span>{http_testcli}"</span> <span class="variable">$variant</span> {</span><br><span class="line">         <span class="number">0.51</span>%          .one;</span><br><span class="line">         <span class="number">20.0</span>%          .two;</span><br><span class="line">         <span class="number">50.5</span>%          .three;</span><br><span class="line">         <span class="comment">#40%           .four;</span></span><br><span class="line">         *              <span class="string">""</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">        server_name split_clients.test.com;</span><br><span class="line">        error_log  logs/error.log  debug;</span><br><span class="line">        default_type text/plain;</span><br><span class="line">        location /{</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span> <span class="string">'ABtestfile$variant\n'</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'testcli: 354165131351315aaaabb' split_clients.test.com/</span></span><br><span class="line">ABtestfile</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'testcli: 354165131351315aaaabb&amp;&amp;&amp;&amp;ddddddd' split_clients.test.com/</span></span><br><span class="line">ABtestfile.three</span><br></pre></td></tr></tbody></table></figure></li>
<li><p>根据 IP 地址范围的匹配生成新变量：geo 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220180039.png" alt="image-20210220180038644"></p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210220180108.png" alt="image-20210220180107063"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat geo.conf </span></span><br><span class="line">geo <span class="variable">$country</span> {</span><br><span class="line">    default        ZZ;</span><br><span class="line">    <span class="comment">#include        conf/geo.conf;</span></span><br><span class="line">    proxy          <span class="number">127.0</span>.<span class="number">0.1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="number">127.0</span>.<span class="number">0.0</span>/<span class="number">24</span>   US;</span><br><span class="line">    <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">32</span>   RU;</span><br><span class="line">    <span class="number">10.1</span>.<span class="number">0.0</span>/<span class="number">16</span>    RU;</span><br><span class="line">    <span class="number">192.168</span>.<span class="number">1.0</span>/<span class="number">24</span> UK;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">	server_name geo.test.com;</span><br><span class="line">	location /{</span><br><span class="line">                <span class="keyword">return</span> <span class="number">200</span> <span class="string">'$country\n'</span>;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># ../../sbin/nginx -s reload</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'X-Forwarded-For: 10.1.0.0,127.0.0.1,172.27.57.6' geo.test.com</span></span><br><span class="line">ZZ</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># curl -H 'X-Forwarded-For: 10.1.0.0,127.0.0.1,192.168.1.123' geo.test.com</span></span><br><span class="line">UK</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> ~]<span class="comment"># curl -H 'X-Forwarded-For: 10.1.0.0' geo.test.com</span></span><br><span class="line">RU</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> ~]<span class="comment"># curl -H 'X-Forwarded-For: 10.1.0.0,127.0.0.1' geo.test.com</span></span><br><span class="line">RU</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>使用变量获得用户的地理位置：geoip 模块   </p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222151516.png" alt="image-20210222151514513"></p>
<figure class="highlight powershell"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加模块</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># ./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_realip_module --with-http_auth_request_module --add-module=/data/soft/nginx/nginx-http-concat --with-http_sub_module --with-http_addition_module --with-http_secure_link_module --with-http_geoip_module</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下载安装GeoIp(nginx是C语言编写的)</span></span><br><span class="line"><span class="comment"># 访问地址：https://dev.maxmind.com/geoip/legacy/downloadable/</span></span><br><span class="line"><span class="comment"># 下载地址：https://github.com/maxmind/geoip-api-c/releases</span></span><br><span class="line"><span class="comment"># 安装编译</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">nginx</span>]<span class="comment"># tar -zxvf GeoIP-1.6.12.tar.gz</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">GeoIP</span>-<span class="number">1.6</span><span class="type">.12</span>]<span class="comment"># ./configure </span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">GeoIP</span>-<span class="number">1.6</span><span class="type">.12</span>]<span class="comment"># make</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">GeoIP</span>-<span class="number">1.6</span><span class="type">.12</span>]<span class="comment"># make install</span></span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">share</span>]<span class="comment"># cd /usr/share/GeoIP</span></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">GeoIP</span>]<span class="comment"># ll</span></span><br><span class="line">total <span class="number">59784</span></span><br><span class="line">lrwxrwxrwx  <span class="number">1</span> root root       <span class="number">18</span> Feb <span class="number">16</span> <span class="number">17</span>:<span class="number">12</span> GeoIP.dat -&gt; GeoLiteCountry.dat</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--. <span class="number">1</span> root root <span class="number">56548946</span> Jun  <span class="number">8</span>  <span class="number">2018</span> GeoLite2<span class="literal">-City</span>.mmdb</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--. <span class="number">1</span> root root  <span class="number">3423846</span> Jun  <span class="number">8</span>  <span class="number">2018</span> GeoLite2<span class="literal">-Country</span>.mmdb</span><br><span class="line"><span class="literal">-rw</span><span class="literal">-r</span>-<span class="literal">-r</span>--  <span class="number">1</span> root root  <span class="number">1242574</span> Apr  <span class="number">4</span>  <span class="number">2018</span> GeoLiteCountry.dat</span><br><span class="line"></span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> <span class="type">conf.d</span>]<span class="comment"># cat geoip.conf </span></span><br><span class="line">geoip_country         /usr/share/GeoIP/GeoIP.dat;</span><br><span class="line">geoip_city            /usr/share/GeoIP/GeoLiteCountry.dat;</span><br><span class="line">geoip_proxy           <span class="number">127.0</span>.<span class="number">0.1</span>/<span class="number">32</span>;</span><br><span class="line">geoip_proxy_recursive on;</span><br><span class="line"></span><br><span class="line">server {</span><br><span class="line">	server_name geoip.test.com;</span><br><span class="line">	error_log logs/myerror.log info;</span><br><span class="line">	keepalive_requests <span class="number">2</span>;</span><br><span class="line">	keepalive_timeout <span class="number">75</span>s <span class="number">20</span>;</span><br><span class="line">	location /{</span><br><span class="line">		<span class="keyword">return</span> <span class="number">200</span> <span class="string">'country:$geoip_country_code,$geoip_country_code3,$geoip_country_name</span></span><br><span class="line"><span class="string">country from city:$geoip_city_country_code,$geoip_city_country_code3,$geoip_city_country_name</span></span><br><span class="line"><span class="string">city:$geoip_area_code,$geoip_city_continent_code,$geoip_dma_code</span></span><br><span class="line"><span class="string">$geoip_latitude,$geoip_longitude,$geoip_region,$geoip_region_name,$geoip_city,$geoip_postal_code</span></span><br><span class="line"><span class="string">'</span>;</span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line">[<span class="type">root</span>@<span class="type">ecs</span> ~]<span class="comment"># curl -H 'X-Forwarded-For: 124.205.155.154' geoip.test.com</span></span><br></pre></td></tr></tbody></table></figure></li>
<li><p>对客户端使用 keepalive 提升连接效率</p>
<p><img src="https://gitee.com/dong618/blog/raw/master/img/202102/20210222160837.png" alt="image-20210222160836086"></p>
</li>
</ol>

    </div>

    
    
    
      

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>dong
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://www.sxyfyr.com/2021/03/04/Nginx%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86100%E8%AE%B2/" title="Nginx 核心知识 100 讲">https://www.sxyfyr.com/2021/03/04/Nginx核心知识100讲/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Nginx/" rel="tag"># Nginx</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/03/04/Elasticsearch%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%AE%9E%E6%88%98/" rel="prev" title="Elasticsearch 核心技术与实战">
      <i class="fa fa-chevron-left"></i> Elasticsearch 核心技术与实战
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86100%E8%AE%B2%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="nav-number">1.</span> <span class="nav-text">Nginx 核心知识 100 讲学习笔记</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%9D%E8%AF%86nginx"><span class="nav-number">2.</span> <span class="nav-text">初识 nginx</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80-%E4%B8%80"><span class="nav-number">3.</span> <span class="nav-text">Nginx 架构基础 (一)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx%E6%9E%B6%E6%9E%84%E5%9F%BA%E7%A1%80-%E4%BA%8C"><span class="nav-number">4.</span> <span class="nav-text">Nginx 架构基础 (二)</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%AF%A6%E8%A7%A3HTTP%E6%A8%A1%E5%9D%97"><span class="nav-number">5.</span> <span class="nav-text">详解 HTTP 模块</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">dong</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank"><a href="https://beian.miit.gov.cn" target="_blank">晋ICP备2021005007号-1</a> </a>
  </div>

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">dong</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">79k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">1:11</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
